{{template "base" .}} {{define "title"}}Upload{{end}} {{define "main"}}
<h2>Upload bộ test</h2>
<p>Upload file zip chứa nhiềù test case</p>
<form id="form">
  <input type="file" accept=".zip" name="fileSuite" required />
  <button>Upload</button>
  <p>
    Note: Nên đặt tên theo cú pháp "tencuaban-tentestcase.zip" để mọi người biết
    bộ test của ai
  </p>
</form>
<h3>Hướng dẫn tạo bộ test</h3>
<a href="/tests/case-1.zip" download="case-1.zip">Tải bộ test mẫu</a>

<p>
  Một bộ test bao gồm nhiều test case. Mỗi test case sẽ được chứa trong một thư
  mục. Mỗi thư mục test case cần có một file có tên <code>result.txt</code>, là
  kết quả màn hình (stdout) sau khi chạy <code>main.cpp</code>.
</p>

<h4>Cách 1: Sử dụng <code>main.cpp</code> của app</h4>
<p>
  Mình có chuẩn bị một file <code>main.cpp</code> có thể ghi kết quả output và
  copy các file input vào một thư mục. Các thư mục này có thể được zip lại và
  upload làm bộ test.
</p>
<ul>
  <li>
    Thay thế nội dung <code>main.cpp</code> bằng code trong file
    <a
      target="_blank"
      href="https://gist.github.com/hoangvvo/2407c50e2969d205bac9599d46c1c4a5#file-main-write-cpp"
      ><code>main-write.cpp</code></a
    >.
  </li>
  <li>Chỉnh lại các file input</li>
  <li>
    Chạy chương trình, nhập số tt test N. Sau khi chạy, code sẽ tạo một folder
    có tên <code>test"N"</code>
  </li>
  <li>
    Lặp lại các bước trên. Sau đó nén các thư mục <code>test"N"</code> vào một
    file zip. Upload file đó!
  </li>
</ul>
<p>
  Ngoài ra các bạn có thể xem qua file
  <a
    target="_blank"
    href="https://gist.github.com/hoangvvo/2407c50e2969d205bac9599d46c1c4a5#file-main-cpp"
    ><code>main.cpp</code></a
  >
  web app sử dụng để chấm bài. (file này có output như file trên nhưng in ra màn
  hình thay vì viết vào file)
</p>
<h4>Cách 2: Sử dụng file main.cpp riêng</h4>
App chấm bài hoạt động theo quy tắc so sánh output ra màn hình (stdout) sau khi
chạy file <code>main.cpp</code>. Trong file zip, bạn có thể bỏ kèm một file
<code>main.cpp</code> (phải nằm ngoài cùng). Chương trình sẽ chạy file đó và ghi
lại kết quả màn hình, sau đó so sánh với file <code>result.txt</code> trong từng
folder test case.

<h2>bộ test đã được upload</h2>
<blockquote>
  Vui lòng chỉ xóa nếu bộ test là của bạn hoặc đã được người upload cho phép!
</blockquote>
<table style="table-layout: auto">
  <thead>
    <tr>
      <th>Name</th>
      <th>Uploaded on</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {{ range .Suites }}
    <tr id="suite-{{ .Name }}">
      <td>{{ .Name }}</td>
      <td>{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}</td>
      <td>
        <button onclick="downloadSuite('{{ .Name }}')">Download</button
        ><button onclick="deleteSuite('{{ .Name }}')">Delete</button>
      </td>
    </tr>
    {{ end }}
  </tbody>
</table>
<script>
  async function downloadSuite(suiteName) {
    const el = document.createElement("a");
    el.setAttribute("href", `/tests/${suiteName}`);
    el.setAttribute("download", suiteName);
    el.style.display = "none";
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async function deleteSuite(suiteName) {
    const result = await Swal.fire({
      title: "Are you sủe?",
      text: "bộ test này sẽ bị xóa mãi mãi!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Tới luôn đê!",
      preConfirm: (login) => {
        return fetch(`/upload/${suiteName}`, { method: "DELETE" }).then(
          (response) => response.json()
        );
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    if (!result.isConfirmed) return;

    if (result.value.error) {
      Swal.fire({
        icon: "error",
        title: "Thôi toang!",
        text: result.value.error,
      });
    } else {
      Swal.fire("Đã xóa!", "Bộ test đã bị xóa", "success");
      document.getElementById(`suite-${suiteName}`).remove();
    }
  }
  const form = document.getElementById("form");
  form.onsubmit = async function submit(event) {
    event.preventDefault();
    const formData = new FormData();
    const file = event.target.fileSuite.files[0];
    if (!file) return;
    formData.append("suite", file);
    const result = await Swal.fire({
      title: `Are you sủe?`,
      text: `Bạn có muốn upload bộ test ${file.name}? (hãy chắc chắn nội dụng file zip chính xác)`,
      icon: "info",
      showCancelButton: true,
      confirmButtonText: "Tới luôn đê!",
      preConfirm: (login) => {
        return fetch(`/upload`, { method: "POST", body: formData }).then(
          (response) => response.json()
        );
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    if (!result.isConfirmed) return;

    if (result.value.error) {
      Swal.fire({
        icon: "error",
        title: "Thôi toang!",
        text: result.value.error,
      });
    } else {
      await Swal.fire("Upload thành công!", "Thank you", "success");
      location.reload();
    }
  };
</script>
{{end}}
