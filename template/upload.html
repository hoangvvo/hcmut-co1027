{{template "base" .}} {{define "title"}}Upload{{end}} {{define "main"}}
<h2>Upload test suite</h2>
<p>Upload file zip chứa nhiềù test case</p>
<form id="form">
  <input type="file" accept=".zip" name="fileSuite" required />
  <button>Upload</button>
  <p>Note: Nên đặt tên theo cú pháp "tencuaban-tentestcase.zip" để mọi người biết test suite của ai</p>
</form>
<h3>Hướng dẫn tạo test suite</h3>
<a href="/tests/case-1.zip" download="case-1.zip">Tải test suite mẫu</a>
<p>
  Một test suite sẽ bao gồm nhiều test case. Mỗi test case sẽ được chứa trong
  một folder (tên folder sẽ được dùng làm tên case). Các folder phải được nén
  dưới dạng file <code>zip</code>.
</p>
<p>Trong mỗi folder phải có những file sau:</p>
<ul>
  <li>input1.txt</li>
  <li>tc1-file-ntb1.txt</li>
  <li>tc1-file-ntb2.txt</li>
  <li>tc1-file-ntb3.txt</li>
  <li>tc1-file-tag.txt</li>
</ul>
<p>Các file trên có thể được đổi tên tùy trường hợp.</p>
Ngoài ra test suite còn phải chứa một file tên <code>result.txt</code>, chứa nội
dung stdout sau khi chạy file.
<a
  href="http://e-learning.hcmut.edu.vn/mod/folder/view.php?id=796842"
  target="_blank"
  >main.cpp gốc</a
>. Ví dụ:

<pre><code>tc1-file-ntb1.txt
tc1-file-ntb2.txt
tc1-file-ntb3.txt
(2,0)-(2,1)
RRRUDL
tc1-file-tag.txt
Rachel
pwd1: 0101000002
pwd2: 1219999999
pwd3: 9931333333
List passwords: 0101000002;1219999999;9931333333;1310000002;9042333335;0250333333;0351333335;0351333335;0452333337
Can reach: 0
outTimes: 28;42
outCatchUps: N;N
pinky@cse.com;RachelRachelRachel</code></pre>
<h2>Test suite đã được upload</h2>
<blockquote>
  Vui lòng chỉ xóa nếu test suite là của bạn hoặc đã được người upload cho phép!
</blockquote>
<table style="table-layout: auto">
  <thead>
    <tr>
      <th>Name</th>
      <th>Uploaded on</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {{ range .Suites }}
    <tr id="suite-{{ .Name }}">
      <td>{{ .Name }}</td>
      <td>{{ .CreatedAt.Format "2006-01-02T15:04:05Z07:00" }}</td>
      <td>
        <button onclick="downloadSuite('{{ .Name }}')">Download</button
        ><button onclick="deleteSuite('{{ .Name }}')">Delete</button>
      </td>
    </tr>
    {{ end }}
  </tbody>
</table>
<script>
  async function downloadSuite(suiteName) {
    const el = document.createElement("a");
    el.setAttribute("href", `/tests/${suiteName}`);
    el.setAttribute("download", suiteName);
    el.style.display = "none";
    document.body.appendChild(el);
    el.click();
    document.body.removeChild(el);
  }
  async function deleteSuite(suiteName) {
    const result = await Swal.fire({
      title: "Are you sủe?",
      text: "Test suite này sẽ bị xóa mãi mãi!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Tới luôn đê!",
      preConfirm: (login) => {
        return fetch(`/upload/${suiteName}`, { method: "DELETE" }).then(
          (response) => response.json()
        );
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    if (!result.isConfirmed) return;

    if (result.value.error) {
      Swal.fire({
        icon: "error",
        title: "Thôi toang!",
        text: result.value.error,
      });
    } else {
      Swal.fire("Đã xóa!", "Bộ test đã bị xóa", "success");
      document.getElementById(`suite-${suiteName}`).remove();
    }
  }
  const form = document.getElementById("form");
  form.onsubmit = async function submit(event) {
    event.preventDefault();
    const formData = new FormData();
    const file = event.target.fileSuite.files[0];
    if (!file) return;
    formData.append("suite", file);
    const result = await Swal.fire({
      title: `Are you sủe?`,
      text: `Bạn có muốn upload test suite ${file.name}? (hãy chắc chắn nội dụng file zip chính xác)`,
      icon: "info",
      showCancelButton: true,
      confirmButtonText: "Tới luôn đê!",
      preConfirm: (login) => {
        return fetch(`/upload`, { method: "POST", body: formData }).then(
          (response) => response.json()
        );
      },
      allowOutsideClick: () => !Swal.isLoading(),
    });

    if (!result.isConfirmed) return;

    if (result.value.error) {
      Swal.fire({
        icon: "error",
        title: "Thôi toang!",
        text: result.value.error,
      });
    } else {
      await Swal.fire(
        "Upload thành công!",
        "Cảm ơn bạn đã upload bộ test",
        "success"
      );
      location.reload();
    }
  };
</script>
{{end}}
